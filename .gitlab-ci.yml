stages:
  - base
  - language
  - tool
  - service

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://localhost:2375

.build-image: &build-image
  image: docker:18.09.9
  services:
    - docker:18.09.9-dind
  tags:
    - platform:k8s
    - runner:shared
  allow_failure: false

  before_script:
    # prep secrets
    - mkdir ${HOME}/.docker
    - echo "${DOCKER_SECRET}" | base64 -d > ${HOME}/.docker/config.json
    - docker info
  script: # todo: move this into a real script
    - cd ${IMAGE_ROOT}
    - export IMAGE_TAG=${IMAGE_NAME}:${IMAGE_VERSION}-${CI_COMMIT_REF_SLUG}
    - docker build -t ${IMAGE_TAG} .
    - IMAGE_HASH=$(docker images | grep ${IMAGE_NAME} | head -n 1 | awk '{ print $3; }')
    - 'echo "Testing image: ${IMAGE_HASH}"'
    - >-
      docker run --rm -v $(pwd):/tests:ro --entrypoint /usr/local/bin/goss
      ${IMAGE_HASH} --gossfile /tests/Gossfile.yml validate
    - docker push ${IMAGE_TAG}
    - >-
      if [[ "${CI_COMMIT_REF_SLUG}" == "master" ]]; then
      docker tag ${IMAGE_TAG} ${IMAGE_NAME}:${IMAGE_VERSION};
      docker push ${IMAGE_NAME}:${IMAGE_VERSION};
      fi
  after_script:
    - rm -rfv ${HOME}/.docker

image:base:
  <<: *build-image
  stage: base
  only:
    changes:
      - base/Dockerfile
  variables:
    IMAGE_ROOT: base
    IMAGE_NAME: apextoaster/base
    IMAGE_VERSION: "1.2"

# language images
image:golang:
  <<: *build-image
  stage: language
  only:
    changes:
      - golang/Dockerfile
  variables:
    IMAGE_ROOT: golang
    IMAGE_NAME: apextoaster/golang
    IMAGE_VERSION: "1.10"

image:node:
  <<: *build-image
  stage: language
  only:
    changes:
      - node/Dockerfile
  variables:
    IMAGE_ROOT: node
    IMAGE_NAME: apextoaster/node
    IMAGE_VERSION: "11.15"

image:python3:
  <<: *build-image
  stage: language
  only:
    changes:
      - python3/Dockerfile
  variables:
    IMAGE_ROOT: python3
    IMAGE_NAME: apextoaster/python3
    IMAGE_VERSION: "3.6"

# tool images
image:ansible:
  <<: *build-image
  stage: tool
  only:
    changes:
      - ansible/Dockerfile
  variables:
    IMAGE_ROOT: ansible
    IMAGE_NAME: apextoaster/ansible
    IMAGE_VERSION: "2.6"

image:bfg:
  <<: *build-image
  stage: tool
  only:
    changes:
      - bfg/Dockerfile
  variables:
    IMAGE_ROOT: bfg
    IMAGE_NAME: apextoaster/bfg
    IMAGE_VERSION: "1.13"

image:code-climate:
  <<: *build-image
  stage: tool
  only:
    changes:
      - code-climate/Dockerfile
  variables:
    IMAGE_ROOT: code-climate
    IMAGE_NAME: apextoaster/code-climate
    IMAGE_VERSION: "0.6"

image:codecov:
  <<: *build-image
  stage: tool
  only:
    changes:
      - codecov/Dockerfile
  variables:
    IMAGE_ROOT: codecov
    IMAGE_NAME: apextoaster/codecov
    IMAGE_VERSION: "3.1"

image:hugo:
  <<: *build-image
  stage: tool
  only:
    changes:
      - hugo/Dockerfile
  variables:
    IMAGE_ROOT: hugo
    IMAGE_NAME: apextoaster/hugo
    IMAGE_VERSION: "0.58"

image:licensed:
  <<: *build-image
  stage: tool
  only:
    changes:
      - licensed/Dockerfile
  variables:
    IMAGE_ROOT: licensed
    IMAGE_NAME: apextoaster/licensed
    IMAGE_VERSION: "1.5.2"

image:rclone:
  <<: *build-image
  stage: tool
  only:
    changes:
      - rclone/Dockerfile
  variables:
    IMAGE_ROOT: rclone
    IMAGE_NAME: apextoaster/rclone
    IMAGE_VERSION: "1.39"

image:shellcheck:
  <<: *build-image
  stage: tool
  only:
    changes:
      - shellcheck/Dockerfile
  variables:
    IMAGE_ROOT: shellcheck
    IMAGE_NAME: apextoaster/shellcheck
    IMAGE_VERSION: "0.4"

image:sonar-scanner:
  <<: *build-image
  stage: tool
  only:
    changes:
      - sonar-scanner/Dockerfile
  variables:
    IMAGE_ROOT: sonar-scanner
    IMAGE_NAME: apextoaster/sonar-scanner
    IMAGE_VERSION: "3.3"

image:terraform:
  <<: *build-image
  stage: tool
  only:
    changes:
      - terraform/Dockerfile
  variables:
    IMAGE_ROOT: terraform
    IMAGE_NAME: apextoaster/terraform
    IMAGE_VERSION: "0.11"

# service images
image:nexus:
  <<: *build-image
  stage: service
  only:
    changes:
      - nexus/Dockerfile
  variables:
    IMAGE_ROOT: nexus
    IMAGE_NAME: apextoaster/nexus
    IMAGE_VERSION: "3.13"
