stages:
  - base
  - language
  - tool
  - service

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://localhost:2375

.build-image: &build-image
  image: docker
  services:
    - docker:dind
  tags:
    - runner:k8s
  before_script:
    # prep secrets
    - mkdir ${HOME}/.docker
    - echo "${DOCKER_SECRET}" | base64 -d > ${HOME}/.docker/config.json
    - docker info
  script: # todo: move this into a real script
    - cd ${IMAGE_ROOT}
    - export IMAGE_TAG=${IMAGE_NAME}:${IMAGE_VERSION}-${CI_COMMIT_REF_SLUG}
    - docker build -t ${IMAGE_TAG} .
    - IMAGE_HASH=$(docker images | grep ${IMAGE_NAME} | head -n 1 | awk '{ print $3; }')
    - 'echo "Testing image: ${IMAGE_HASH}"'
    - >-
      docker run --rm -v $(pwd):/tests:ro --entrypoint /usr/local/bin/goss
      ${IMAGE_HASH} --gossfile /tests/Gossfile.yml validate
    - docker push ${IMAGE_TAG}
    - >-
      if [[ "${CI_COMMIT_REF_SLUG}" == "master" ]]; then
      docker tag ${IMAGE_TAG} ${IMAGE_NAME}:${IMAGE_VERSION};
      docker push ${IMAGE_NAME}:${IMAGE_VERSION};
      fi

image:base:
  <<: *build-image
  stage: base
  variables:
    IMAGE_ROOT: base
    IMAGE_NAME: apextoaster/base
    IMAGE_VERSION: "1.2"

# language images
image:golang:
  <<: *build-image
  stage: language
  variables:
    IMAGE_ROOT: golang
    IMAGE_NAME: apextoaster/golang
    IMAGE_VERSION: "1.10"

image:node:
  <<: *build-image
  stage: language
  variables:
    IMAGE_ROOT: node
    IMAGE_NAME: apextoaster/node
    IMAGE_VERSION: "10.1"

image:python3:
  <<: *build-image
  stage: language
  variables:
    IMAGE_ROOT: python3
    IMAGE_NAME: apextoaster/python3
    IMAGE_VERSION: "3.5"

# tool images
image:ansible:
  <<: *build-image
  stage: tool
  variables:
    IMAGE_ROOT: ansible
    IMAGE_NAME: apextoaster/ansible
    IMAGE_VERSION: "2.6"

image:bfg:
  <<: *build-image
  stage: tool
  variables:
    IMAGE_ROOT: bfg
    IMAGE_NAME: apextoaster/bfg
    IMAGE_VERSION: "1.13"

image:hugo:
  <<: *build-image
  stage: tool
  variables:
    IMAGE_ROOT: hugo
    IMAGE_NAME: apextoaster/hugo
    IMAGE_VERSION: "0.25"

image:rclone:
  <<: *build-image
  stage: tool
  variables:
    IMAGE_ROOT: rclone
    IMAGE_NAME: apextoaster/rclone
    IMAGE_VERSION: "1.39"

image:terraform:
  <<: *build-image
  stage: tool
  variables:
    IMAGE_ROOT: terraform
    IMAGE_NAME: apextoaster/terraform
    IMAGE_VERSION: "0.11"

# service images
image:nexus:
  <<: *build-image
  stage: service
  variables:
    IMAGE_ROOT: nexus
    IMAGE_NAME: apextoaster/nexus
    IMAGE_VERSION: "3.13"
