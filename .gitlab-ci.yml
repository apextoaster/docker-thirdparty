stages:
  - base
  - main

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://localhost:2375

.image: &image-job
  image: docker
  services:
    - docker:dind
  tags:
    - runner:k8s
  before_script:
    # prep secrets
    - mkdir /root/.docker
    - ln -s /secrets/docker /root/.docker/config.json
    - docker info
  script:
    - docker build -t ${IMAGE_TAG}:${CI_COMMIT_REF_SLUG} ${IMAGE_DIR}
    - docker push ${IMAGE_TAG}
 
build:base:
  <<: *image-job
  stage: base
  variables:
    IMAGE_DIR: base
    IMAGE_TAG: apextoaster/base
 
build:node:
  <<: *image-job
  stage: main
  variables:
    IMAGE_DIR: node
    IMAGE_TAG: apextoaster/node